# GSEA 分析流程说明

## 1. 数据准备

在进行 GSEA 分析之前，需要准备好基因表达数据文件（通常为矩阵格式）。GSEA 分析的一个重要特点是不需要预先筛选差异基因，而是利用所有基因的表达数据进行排序。背景基因集可以是 GO、KEGG 或 Hallmark 等基因集，具体选择取决于研究目的。示例中选用的是 `Hallmark` 基因集。

## 2. R 环境设置

在开始分析前，需加载必要的 R 包以支持数据分析和可视化。主要使用的包包括：

- **msigdbr**：用于从 MSigDB 数据库中获取基因集数据，例如 Hallmark 基因集。
- **clusterProfiler**：提供 GSEA 分析的核心功能。
- **fgsea**：用于执行快速 GSEA 分析，提升计算效率。
- **tidyverse**：用于数据处理和整理。
- **ggplot2** 和 **gridExtra**：用于生成高质量的图形和组合多图布局。
- **cowplot**：用于优化图形排版和样式。


## 3. 数据读取与分组

将准备好的基因表达数据文件 `gene.csv` 读取到 R 环境中，并对样本进行分组。通常根据实验设计，将样本分为两组（例如对照组和实验组）。可以通过指定一组样本名称（如 `group1`），然后使用 `setdiff` 函数将剩余样本归为另一组（如 `group2`）。

## 4. 计算基因排序指标

为了进行 GSEA 分析，需要计算每个基因的排序指标。这一步骤通过对每组样本计算基因表达的平均值，并以两组之间的差异作为排序依据。随后，按照该指标对基因进行降序排列，生成排序后的基因列表，作为后续 GSEA 分析的输入。

## 5. GSEA 分析

### 下载基因集

使用 `msigdbr` 包下载人类（Homo sapiens）的 Hallmark 基因集，使用这个基因集作为背景基因集，这些基因集包含了生物学过程中重要的基因集合。下载完成后，将基因集按名称拆分为列表形式，便于后续分析。

### 执行 GSEA 分析

利用 `fgsea` 包执行快速 GSEA 分析。通过输入排序后的基因列表和基因集列表，计算每个基因集的富集分数（Enrichment Score, ES）及其统计显著性（p 值）。分析过程中可设置参数（如基因集大小范围、并行计算线程数等）以优化计算效率。

### 提取显著通路

根据 GSEA 分析结果的 p 值对所有基因集进行排序，并提取最显著的前 `8`个通路名称。这些通路反映了数据中最显著的生物学过程或功能模块。

## 6. GSEA 结果可视化

### 定义辅助函数

为了更好地展示 GSEA 分析结果，定义两个辅助函数：

- **计算富集分数曲线函数**：用于计算每个基因集的富集分数曲线。
- **生成单个 GSEA 图函数**：用于绘制单个基因集的 GSEA 图形。

### 绘制 GSEA 图形

GSEA 图形通常由三部分组成：

1. **ES 曲线部分**：展示基因集的富集分数变化趋势。
2. **基因集位置**：标记基因集中成员在排序列表中的位置。
3. **排序指标分布**：显示基因排序指标的整体分布情况。

利用上述函数，生成前 8 个最显著通路的 GSEA 图形，并将其组合成每一行包含 `3`个图形的布局。最终将组合图形保存为 PNG 文件（如 `GSEA_top8_pathways.png`），以便后续报告或展示使用。

## 7. 保存结果

完成 GSEA 分析后，将分析结果保存为 CSV 文件（如 `gsea_results.csv`），包括每个基因集的富集分数、p 值及其他统计信息。所有输出文件默认保存在当前工作目录中。如果需要调整图表样式或参数，可以根据代码中的注释说明进行修改。

---

## 备注
- GSEA分析需要基因的表达量，因为需基因排序（按logFC/p值等）
- 所有输出文件默认保存在当前工作目录。
